<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Minnesota Population Center" />

<meta name="date" content="2017-12-15" />

<title>Geographic Data in ipumsr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#header {
text-align: center;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; }  code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>

</head>

<body>




<h1 class="title toc-ignore">Geographic Data in <code>ipumsr</code></h1>
<h4 class="author"><em>Minnesota Population Center</em></h4>
<h4 class="date"><em>2017-12-15</em></h4>



<pre><code>## Could not find data and so could not run vignette.
## 
## The data is available on github - you can install it using the following commands: 
##   if (!require(devtools)) install.packages('devtools')
##   devtools::install_github('mnpopcenter/ipumsr/ipumsexamples')
## After installation, the data should be available for this vignette.</code></pre>
<pre><code>## Warning: package 'sf' was built under R version 3.4.3</code></pre>
<p>A lesser-known part of the IPUMS data catalog is our geographic boundary files. For many projects, our geographers have created shape files to complement the micro- and tabular data we provide. These boundaries are stored in shape files, which can be downloaded from our website (in slightly different places depending on the project):</p>
<ul>
<li>Microdata projects like <a href="https://www.idhsdata.org/idhs/gis.shtml">IPUMS DHS</a>, <a href="https://international.ipums.org/international/geography_gis.shtml">IPUMS International</a> and <a href="https://usa.ipums.org/usa/volii/tgeotools.shtml">IPUMS USA</a> provide shape files on dedicated geography pages that are separate from the microdata extract system.</li>
<li><a href="https://www.nhgis.org">IPUMS NHGIS</a> provides access to the shape files relevant to your current extract as part of the system to create the data extract. The shape files are a separate download, but are on the same page as the data.</li>
<li><a href="https://www.terrapop.org/">IPUMS Terra</a> provides shape files inside the extract bundle and allows for aggregating microdata and raster data into the boundaries.</li>
</ul>
<p>(Note: The ipumsr package does not yet support IPUMS Terra data. We hope to add support for IPUMS Terra soon.)</p>
<p>This vignette offers an introduction to the types of geographies available through IPUMS, then uses example data to walk through two typical workflows for using boundary data with (1) IPUMS DHS, IPUMS International or IPUMS USA, and (2) IPUMS NHGIS. The vignette focuses on the specifics of working with IPUMS geographic data, and is by no means an overview of working with geographic data in R. In the examples, I show how to make static graphs using ggplot2, but there are many other R packages to help you do all sorts of things with geographic data, including making interactive maps and performing geospatial analysis. <a href="#resources">At the end of this vignette</a>, there are some resources for learning more.</p>
<section id="introduction-to-ipums-geographies" class="level2">
<h2>Introduction to IPUMS Geographies</h2>
<p>IPUMS geographic data can be classified along two dimensions:</p>
<section id="harmonized-vs.non-harmonized" class="level3">
<h3>Harmonized vs. Non-Harmonized</h3>
<p>Changing boundaries complicate longitudinal analyses of geographic units. For many geographies IPUMS provides boundary files that have been made consistent by combining geographies that share area for different time periods (see the project specific geography webpages for more details). IPUMS geography pages refer to these as “harmonized”, “integrated” or “consistent”. Boundaries that have not been made consistent over time are often referred to as “year-specific,” or may simply be labelled with the year to which they pertain (eg “2010 PUMAs” for IPUMS USA).</p>
</section>
<section id="geographic-level" class="level3">
<h3>Geographic level</h3>
<p>The specificity of the geography (eg states and counties in the United States). IPUMS often provides multiple levels of data, sometimes overlapping (as the case of counties within states) but sometimes not (eg zip codes in the US may not fit within county boundaries).</p>
</section>
</section>
<section id="a-note-on-rs-geospatial-packages-sf-vs-sp" class="level2">
<h2>A Note on R’s Geospatial Packages: <code>sf</code> vs <code>sp</code></h2>
<p>The <code>ipumsr</code> package allows for loading geospatial data in two formats (sf for Simple Features and sp for Spatial). The <code>sf</code> package is relatively new, and so does not have as widespread support as the <code>sp</code> package. However, (in my opinion) it does allow for easier analysis, and so may be a better place to start if you have not used GIS data in R before.</p>
<p>All examples in this vignette will use the sf package, but sp’s functionality is generally similar. The only place where the code is noticeably different is for making plots. See the <a href="#resources">resources at the end of this vignette</a> for some instructions on plotting with the sp package.</p>
</section>
<section id="basic-workflow-for-ipums-dhs-ipums-international-and-ipums-usa" class="level2">
<h2>Basic workflow for IPUMS DHS, IPUMS International, and IPUMS USA</h2>
<p>Every analysis will be slightly different, but in general the workflow for integrating geographic data and microdata from IPUMS DHS, IPUMS International or IPUMS USA can be divided into four steps before we’re ready to analyze the data:</p>
<ol type="1">
<li>Download microdata and shape files</li>
<li>Load microdata and shape files into R</li>
<li>Transform data</li>
<li>Merge microdata and boundary data</li>
</ol>
<p>In this vignette, I will first walk through these steps for an example that maps geographic variation in the use of solid fuel for cooking in households with children aged 0-5 in Colombia. Later on in the vignette, I show a more <a href="#complicated">complicated example</a> that combines the data for Colombia, Ecuador and Peru.</p>
<p>The data for this example is included in the package <code>ipumsexamples</code>, which is available on github. If you want to run the code from this vignette you will need to install it by running the following commands:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="cf">if</span> (<span class="op">!</span><span class="kw">require</span>(devtools)) <span class="kw">install.packages</span>(devtools)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2">devtools<span class="op">::</span><span class="kw">install_github</span>(<span class="st">&quot;mnpopcenter/ipumsr/ipumsexamples&quot;</span>)</a></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># This function helps find the data from the ipumsexamples package for us</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2">ex_file &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb4-3" data-line-number="3">  <span class="kw">system.file</span>(<span class="st">&quot;extdata&quot;</span>, x, <span class="dt">package =</span> <span class="st">&quot;ipumsexamples&quot;</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">}</a></code></pre></div>
<p>Before you work on the data for yourself, I recommend reading the specifics about the project’s geographic data on the IPUMS website (<a href="https://www.idhsdata.org/idhs/gis.shtml">IPUMS DHS</a> <a href="https://international.ipums.org/international/geography_gis.shtml">IPUMS International</a> and <a href="https://usa.ipums.org/usa/volii/tgeotools.shtml">IPUMS USA</a>). Each project has its own idiosyncrasies that you’ll want to understand before diving in.</p>
<section id="download-microdata-and-shape-files" class="level3">
<h3>1) Download microdata and shape files</h3>
<p>From the data extract engine I see that the variable FUELCOOK is available in three censuses from Colombia (1985, 1993 and 2005).</p>
<p>The decision to use harmonized or year-specific geographic variables depends on how you want to analyze change over time. If I want to be able to compare how the data has changed over time for particular geographies, I need to use the harmonized version of the Colombian geography so that the geographic units are the same. In this case, I will use the harmonized vesrion, but other analyses could use the non-harmonized versions (like if I cared about showing the most up-to-date boundaries more than being able to compare across years). Similarly, the level of the geographic variables you choose depends on your research question. For this example I will use level 1 geography.</p>
<p>Once I know which geographic variables I want, I need to add those geographic variables to my microdata extract <em>and</em> download the corresponding shape files from the project specific geography page.</p>
<p>In the IPUMS International microdata extract system, I added the variable GEOLEV1 (which contains harmonized first-level geography) for Colombia. To download shape files on the <a href="https://international.ipums.org/international/geography_gis.shtml">IPUMS International geography page</a>, I can click on the “GIS Boundary Files Download” link. For Colombia, I’ll want to look on the “Spatially harmonized first-level geography” page.</p>
</section>
<section id="load-microdata-and-shape-files-into-r" class="level3">
<h3>2) Load microdata and shape files into R</h3>
<p>The <code>read_ipums_micro()</code> function loads the data and the <code>read_ipums_sf()</code> (or <code>read_ipums_sp()</code>) function loads the shape files.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">suppressPackageStartupMessages</span>({</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="kw">library</span>(ipumsr)</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="kw">library</span>(sf)</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">  <span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">  <span class="kw">library</span>(ggplot2)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">})</a>
<a class="sourceLine" id="cb5-7" data-line-number="7"></a>
<a class="sourceLine" id="cb5-8" data-line-number="8"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb5-9" data-line-number="9">ipumsi_ddi_file &lt;-<span class="st"> </span><span class="kw">ex_file</span>(<span class="st">&quot;ipumsi_00011.xml&quot;</span>)</a>
<a class="sourceLine" id="cb5-10" data-line-number="10">ipumsi_ddi &lt;-<span class="st"> </span><span class="kw">read_ipums_ddi</span>(ipumsi_ddi_file)</a>
<a class="sourceLine" id="cb5-11" data-line-number="11">ipumsi_data &lt;-<span class="st"> </span><span class="kw">read_ipums_micro</span>(ipumsi_ddi_file, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"></a>
<a class="sourceLine" id="cb5-13" data-line-number="13"><span class="co"># Note this data contains data from Ecuador and Peru for use later on</span></a>
<a class="sourceLine" id="cb5-14" data-line-number="14"><span class="co"># in the vignette. For now we will just filter it out of our data</span></a>
<a class="sourceLine" id="cb5-15" data-line-number="15">ipumsi_data &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb5-16" data-line-number="16"><span class="st">  </span><span class="kw">filter</span>(COUNTRY <span class="op">==</span><span class="st"> </span><span class="dv">170</span>) <span class="co"># Labelled value 170 is Colombia</span></a>
<a class="sourceLine" id="cb5-17" data-line-number="17"></a>
<a class="sourceLine" id="cb5-18" data-line-number="18"><span class="co"># Load shape file</span></a>
<a class="sourceLine" id="cb5-19" data-line-number="19">colombia_shape &lt;-<span class="st"> </span><span class="kw">read_ipums_sf</span>(<span class="kw">ex_file</span>(<span class="st">&quot;geo1_co1964_2005.zip&quot;</span>), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a></code></pre></div>
</section>
<section id="transform-data" class="level3">
<h3>3) Transform data</h3>
<p>Our first data transformation is a step that most analyses will need regardless of whether they use geographic data or not.Though IPUMS microdata has been cleaned and formatted to be easy to use, generally there is at least some data processing we need to do (as discussed in the value-labels vignette).</p>
<p>In this example, I want to make the solid fuel use variable binary and also use the value labels for COUNTRY, SAMPLE and AGE2, but zap them for the geography variables.</p>
<p>When combining with shape files, the shape files also generally have the labels for the geographic units, so we do not need to keep the labels on the geographic variables in the microdata. Also, because the name of a geography may not be unique (eg there are 8 states in the US with a Fulton County), it’s better to merge on the unique numeric code.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># Convert labelled values to factors where useful (and zap elsewhere)</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># See the value-labels vignette for more on this process.</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3">fuel_labels &lt;-<span class="st"> </span><span class="kw">ipums_val_labels</span>(ipumsi_data<span class="op">$</span>FUELCOOK)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">fuel_missing_lbls &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">  <span class="st">&quot;NIU (not in universe)&quot;</span>, <span class="st">&quot;Multiple fuels&quot;</span>, <span class="st">&quot;Other combinations&quot;</span>, <span class="st">&quot;Other&quot;</span>, <span class="st">&quot;Unknown/missing&quot;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6">)</a>
<a class="sourceLine" id="cb6-7" data-line-number="7">fuel_solid_vals &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">50</span><span class="op">:</span><span class="dv">56</span>, <span class="dv">61</span>, <span class="dv">73</span>, <span class="dv">74</span>, <span class="dv">75</span>)</a>
<a class="sourceLine" id="cb6-8" data-line-number="8"></a>
<a class="sourceLine" id="cb6-9" data-line-number="9">ipumsi_data &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(COUNTRY, SAMPLE, AGE2), <span class="op">~</span><span class="kw">as_factor</span>(<span class="kw">lbl_clean</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="st">  </span><span class="co"># We will get labels from shape file for geographic variables</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;GEO&quot;</span>)), zap_labels) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb6-14" data-line-number="14">    <span class="dt">SOLIDFUEL =</span> FUELCOOK <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb6-15" data-line-number="15"><span class="st">      </span><span class="kw">lbl_na_if</span>(<span class="op">~</span>.lbl <span class="op">%in%</span><span class="st"> </span>fuel_missing_lbls) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-16" data-line-number="16"><span class="st">      </span><span class="kw">lbl_relabel</span>(</a>
<a class="sourceLine" id="cb6-17" data-line-number="17">        <span class="kw">lbl</span>(<span class="dv">0</span>, <span class="st">&quot;Non-solid Fuel&quot;</span>) <span class="op">~</span><span class="st"> </span><span class="op">!</span>.val <span class="op">%in%</span><span class="st"> </span>fuel_solid_vals,</a>
<a class="sourceLine" id="cb6-18" data-line-number="18">        <span class="kw">lbl</span>(<span class="dv">1</span>, <span class="st">&quot;Solid Fuel&quot;</span>) <span class="op">~</span><span class="st"> </span>.val <span class="op">%in%</span><span class="st"> </span>fuel_solid_vals</a>
<a class="sourceLine" id="cb6-19" data-line-number="19">      ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb6-20" data-line-number="20"><span class="st">      </span><span class="kw">as_factor</span>(),</a>
<a class="sourceLine" id="cb6-21" data-line-number="21">    <span class="dt">FUELCOOK =</span> <span class="kw">as_factor</span>(FUELCOOK)</a>
<a class="sourceLine" id="cb6-22" data-line-number="22">  )</a></code></pre></div>
<p>The next data transformation will be to summarize the microdata to the geographic unit. Microdata has one observation per person, but usually when we are making a map, we want a summary measure for a geographic unit. In this case, because we have data at three time points for Colombia, we summarize by geographic unit and year.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">ipumsi_summary &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(YEAR, COUNTRY, GEOLEV1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pct_solid =</span> <span class="kw">mean</span>(SOLIDFUEL <span class="op">==</span><span class="st"> &quot;Solid Fuel&quot;</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
</section>
<section id="merge-microdata-and-boundary-data" class="level3">
<h3>4) Merge microdata and boundary data</h3>
<p>The function <code>ipums_shape_inner_join()</code> allows us to combine the data and shape file while smoothing out some of the complications because the data and shape files are provided in slightly different formats (eg, the geography ID variable is numeric in the microdata, but stored as character in the shape file). It also gives a message when some of the data has been dropped by the join.</p>
<p>Before we are able to join the data, we need to determine what the geographic ID is called in each file. Unfortunately, for microdata projects, the name of the variable is often different between the two. The project’s website often has information explaining how they are named, but they may not always describe the exact abbreviations. In this example, in the data it is called “GEOLEV1” and in the shape file it is “GEOLEVEL1”.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">names</span>(ipumsi_summary)</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">names</span>(colombia_shape)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3"></a>
<a class="sourceLine" id="cb8-4" data-line-number="4">ipumsi &lt;-<span class="st"> </span><span class="kw">ipums_shape_inner_join</span>(</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">  ipumsi_summary, </a>
<a class="sourceLine" id="cb8-6" data-line-number="6">  colombia_shape,</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">  <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;GEOLEV1&quot;</span> =<span class="st"> &quot;GEOLEVEL1&quot;</span>)</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">)</a></code></pre></div>
<p>Notice that the join warned us about one observation dropping out of the shape file. Because we chose an inner join, all observations that were not in both the microdata and the shape data are dropped from the results. Join failures like this can happen for a variety of reasons.</p>
<p>We can investigate this join failure using the <code>join_failures</code> command.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">join_failures</span>(ipumsi)</a></code></pre></div>
<p>In this case, it appears that the shape file includes Lake Titicaca for mapping purposes, even though no one lives in the lake. We will just leave this boundary out of our dataset.</p>
<p>In general, these kinds of join failures can sometimes indicate that something is wrong with your data. Perhaps: - The wrong shape file was used - The data was not completely loaded - The wrong ID variable was used in the <code>by</code> parameter</p>
<p>But others may not be relevant to your analysis: - There is no population inside of a geography and so it exists in the shape file but not the data (as happened in this case) - A geography was listed in the census, but it’s boundaries are so small that they were not put in the shape file (can happen when shape files are simplified so that they don’t take as much computer resources) - A geography doesn’t actually refer to a place with real boundaries. This happens in some US censuses which have census blocks that refer to “Crews of Vessels” for crews of naval ships. Since ships don’t have a fixed location, they are not included in the boundary file.</p>
</section>
<section id="ready-to-analyze-data" class="level3">
<h3>Ready to analyze data!</h3>
<p>Now the data is ready for us to use. Here’s a quick example of how to make a map with ggplot2.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Note the function `geom_sf()` is currently only in the development version, </span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co"># so you may need to update ggplot2 to run using </span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">#   devtools::install_github(&quot;tidyverse/ggplot2&quot;)</span></a>
<a class="sourceLine" id="cb10-4" data-line-number="4"><span class="cf">if</span> (<span class="st">&quot;geom_sf&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">getNamespaceExports</span>(<span class="st">&quot;ggplot2&quot;</span>)) {</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="kw">ggplot</span>(<span class="dt">data =</span> ipumsi, <span class="kw">aes</span>(<span class="dt">fill =</span> pct_solid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb10-6" data-line-number="6"><span class="st">    </span><span class="kw">geom_sf</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-7" data-line-number="7"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>YEAR) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8"><span class="st">    </span><span class="kw">scale_fill_continuous</span>(<span class="st">&quot;&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb10-9" data-line-number="9"><span class="st">    </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">      <span class="dt">title =</span> <span class="st">&quot;Percent of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel&quot;</span>,</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">      <span class="dt">subtitle =</span> <span class="st">&quot;Colombia (1985, 1993, 2005) Census Data&quot;</span>,</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">      <span class="dt">caption =</span> <span class="kw">paste0</span>(<span class="st">&quot;Source: &quot;</span>, <span class="kw">ipums_file_info</span>(ipumsi_ddi, <span class="st">&quot;ipums_project&quot;</span>))</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">    )</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">}</a></code></pre></div>
</section>
</section>
<section id="basic-workflow-for-ipums-nhgis" class="level2">
<h2>Basic workflow for IPUMS NHGIS</h2>
<p>The geographic data is more tightly integrated with the census data for the IPUMS NHGIS project, but otherwise the process for using IPUMS NHGIS data is similar to using the microdata projects.</p>
<p>Again, the specifics of each analysis will be slightly different, but here is an example showing the median age by census block in Connecticut and Rhode Island.</p>
<section id="download-data-and-shape-files" class="level3">
<h3>1) Download data and shape files</h3>
<p>The IPUMS NHGIS extract engine has better integration of the shape files and data. The website allows you to filter on variables that are only available at a particular geographic level when looking for variables and to select particular levels after selecting a table. Also, the geographic boundary files can be selected alongside the tables using the “GIS Boundary Files” tab. The extract engine also provides a single place to download both the data and the boundary files.</p>
<p>In our example, we select table P13, “Median Age by Sex” at the census block level. Because census block data is so large, the extract engine divides each state’s boundaries into different files, so we also need to select that we want Connecticut and Rhode Island.</p>
</section>
<section id="load-data-and-shape-files-into-r" class="level3">
<h3>2) Load data and shape files into R</h3>
<p>For most uses you will be able to load the data and shape files at the same time using the <code>read_nhgis_sf()</code> (or <code>read_nhgis_sp()</code>) function. Even when the geographic data is divided by the extract engine because of size reasons (like how each census block file is for a single state), these functions will combine the shape files for us. However, if your analysis combines across years or geographic levels, you will need to load the data separately and then combine.</p>
<p>So in our example, we run the following to load the data:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">nhgis_ddi &lt;-<span class="st"> </span><span class="kw">read_ipums_codebook</span>(<span class="kw">ex_file</span>(<span class="st">&quot;nhgis0024_csv.zip&quot;</span>)) </a>
<a class="sourceLine" id="cb11-2" data-line-number="2">nhgis &lt;-<span class="st"> </span><span class="kw">read_nhgis_sf</span>(</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">  <span class="dt">data_file =</span> <span class="kw">ex_file</span>(<span class="st">&quot;nhgis0024_csv.zip&quot;</span>),</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">  <span class="dt">shape_file =</span> <span class="kw">ex_file</span>(<span class="st">&quot;nhgis0024_shape_small.zip&quot;</span>),</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">  <span class="dt">verbose =</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb11-6" data-line-number="6">)</a></code></pre></div>
<p>In other situations, such as combining data from different tables or geographic level, you may need to load the data and shape files separately. In this case, you can use the function <code>read_nhgis()</code> to load the data and <code>read_ipums_sf()</code> (or sp) to load the shape files. In these analyses, the process for combining the data is similar to the process described below for the more complicated <a href="#complicated">IPUMS International workflow</a> where multiple shape files are combined.</p>
</section>
<section id="ready-to-analyze-data-1" class="level3">
<h3>Ready to analyze data!</h3>
<p>Now we’re ready to use the data. Here is a map of the median age for Hartford County, CT and Providence County, RI.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="co"># The median age is 0 for unpopulated counties, set them to NA</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2">nhgis &lt;-<span class="st"> </span>nhgis <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">H77001 =</span> <span class="kw">ifelse</span>(H77001 <span class="op">==</span><span class="st"> </span><span class="dv">0</span>, <span class="ot">NA</span>, H77001))</a>
<a class="sourceLine" id="cb12-4" data-line-number="4"></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="co"># For map filter to Hartford County, CT and Providence County, RI</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6">nhgis_subset &lt;-<span class="st"> </span>nhgis <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(COUNTY <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Hartford County&quot;</span>, <span class="st">&quot;Providence County&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-8" data-line-number="8"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">place_name =</span> <span class="kw">paste0</span>(COUNTY, <span class="st">&quot;, &quot;</span>, STATE))</a>
<a class="sourceLine" id="cb12-9" data-line-number="9"></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"><span class="cf">if</span> (<span class="st">&quot;geom_sf&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">getNamespaceExports</span>(<span class="st">&quot;ggplot2&quot;</span>)) {</a>
<a class="sourceLine" id="cb12-11" data-line-number="11">  <span class="kw">ggplot</span>(<span class="dt">data =</span> nhgis_subset, <span class="kw">aes</span>(<span class="dt">fill =</span> H77001)) <span class="op">+</span></a>
<a class="sourceLine" id="cb12-12" data-line-number="12"><span class="st">    </span><span class="kw">geom_sf</span>(<span class="dt">linetype =</span> <span class="st">&quot;blank&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-13" data-line-number="13"><span class="st">    </span><span class="kw">scale_fill_continuous</span>(<span class="st">&quot;&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-14" data-line-number="14"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>place_name, <span class="dt">scales =</span> <span class="st">&quot;free&quot;</span>) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb12-15" data-line-number="15"><span class="st">    </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb12-16" data-line-number="16">      <span class="dt">title =</span> <span class="st">&quot;Median Age of Population By Census Block&quot;</span>,</a>
<a class="sourceLine" id="cb12-17" data-line-number="17">      <span class="dt">subtitle =</span> <span class="st">&quot;2010 Census&quot;</span>,</a>
<a class="sourceLine" id="cb12-18" data-line-number="18">      <span class="dt">caption =</span> <span class="kw">paste0</span>(</a>
<a class="sourceLine" id="cb12-19" data-line-number="19">        <span class="st">&quot;Source: &quot;</span>, <span class="kw">ipums_file_info</span>(nhgis_ddi, <span class="st">&quot;ipums_project&quot;</span>), <span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>,</a>
<a class="sourceLine" id="cb12-20" data-line-number="20">        <span class="st">&quot;Simplified Census Block boundaries (1% of points retained)&quot;</span></a>
<a class="sourceLine" id="cb12-21" data-line-number="21">      )</a>
<a class="sourceLine" id="cb12-22" data-line-number="22">    )</a>
<a class="sourceLine" id="cb12-23" data-line-number="23">}</a></code></pre></div>
</section>
</section>
<section id="complicated" class="level2">
<h2>Combining multiple shape files</h2>
<p>When combining multiple shape files, the process is generally similar, but it does require some more steps in the “Transform Data” step. To demonstrate, I will continue the IPUMS International example from above, but add the data from Ecuador and Peru.</p>
<p>In this example, I have added the Ecuador 2010 and Peru 2007 censuses, to the IPUMS international example above. These samples also have data for the FUELCOOK variable. Rather than use the harmonized geography, for these countries I chose to usethe non-harmonized data for these 2 countries. Because the FUELCOOK variable is only available in one census for these countries, the benefits of the harmonized version are less important (but once again, this decision depends on the analysis).</p>
<p>I made sure to include the year-specific variables GEO1_EC2010 and GEO1_PE2007 for Ecuador and Peru in the microdata extract, and got the geographic boundary files from the “Year-specific first-level geography” page.</p>
<p>Now I’m ready to load the data into R as before. The only changes are that I no longer filter out the non-Colombian data and load the extra shape files. Then I transform the value labels just as I did when working with Colombia.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2">ipumsi_ddi_file &lt;-<span class="st"> </span><span class="kw">ex_file</span>(<span class="st">&quot;ipumsi_00011.xml&quot;</span>)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">ipumsi_ddi &lt;-<span class="st"> </span><span class="kw">read_ipums_ddi</span>(ipumsi_ddi_file)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">ipumsi_data &lt;-<span class="st"> </span><span class="kw">read_ipums_micro</span>(ipumsi_ddi_file, <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5"></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="co"># Load shape files</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7">colombia_shape &lt;-<span class="st"> </span><span class="kw">read_ipums_sf</span>(<span class="kw">ex_file</span>(<span class="st">&quot;geo1_co1964_2005.zip&quot;</span>), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">ecuador_shape &lt;-<span class="st"> </span><span class="kw">read_ipums_sf</span>(<span class="kw">ex_file</span>(<span class="st">&quot;geo1_ec2010.zip&quot;</span>), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">peru_shape &lt;-<span class="st"> </span><span class="kw">read_ipums_sf</span>(<span class="kw">ex_file</span>(<span class="st">&quot;geo1_pe2007.zip&quot;</span>), <span class="dt">verbose =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb13-10" data-line-number="10"></a>
<a class="sourceLine" id="cb13-11" data-line-number="11"><span class="co"># Convert labelled values to factors where useful (and zap elsewhere)</span></a>
<a class="sourceLine" id="cb13-12" data-line-number="12"><span class="co"># See the value-labels vignette for more on this process.</span></a>
<a class="sourceLine" id="cb13-13" data-line-number="13">fuel_labels &lt;-<span class="st"> </span><span class="kw">ipums_val_labels</span>(ipumsi_data<span class="op">$</span>FUELCOOK)</a>
<a class="sourceLine" id="cb13-14" data-line-number="14">fuel_missing_lbls &lt;-<span class="st"> </span><span class="kw">c</span>(</a>
<a class="sourceLine" id="cb13-15" data-line-number="15">  <span class="st">&quot;NIU (not in universe)&quot;</span>, <span class="st">&quot;Multiple fuels&quot;</span>, <span class="st">&quot;Other combinations&quot;</span>, <span class="st">&quot;Other&quot;</span>, <span class="st">&quot;Unknown/missing&quot;</span></a>
<a class="sourceLine" id="cb13-16" data-line-number="16">)</a>
<a class="sourceLine" id="cb13-17" data-line-number="17">fuel_solid_vals &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">50</span><span class="op">:</span><span class="dv">56</span>, <span class="dv">61</span>, <span class="dv">73</span>, <span class="dv">74</span>, <span class="dv">75</span>)</a>
<a class="sourceLine" id="cb13-18" data-line-number="18"></a>
<a class="sourceLine" id="cb13-19" data-line-number="19">ipumsi_data &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-20" data-line-number="20"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(COUNTRY, SAMPLE, AGE2), <span class="op">~</span><span class="kw">as_factor</span>(<span class="kw">lbl_clean</span>(.))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-21" data-line-number="21"><span class="st">  </span><span class="co"># We will get labels from shape file for geographic variables</span></a>
<a class="sourceLine" id="cb13-22" data-line-number="22"><span class="st">  </span><span class="kw">mutate_at</span>(<span class="kw">vars</span>(<span class="kw">starts_with</span>(<span class="st">&quot;GEO&quot;</span>)), zap_labels) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-23" data-line-number="23"><span class="st">  </span><span class="kw">mutate</span>(</a>
<a class="sourceLine" id="cb13-24" data-line-number="24">    <span class="dt">SOLIDFUEL =</span> FUELCOOK <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb13-25" data-line-number="25"><span class="st">      </span><span class="kw">lbl_na_if</span>(<span class="op">~</span>.lbl <span class="op">%in%</span><span class="st"> </span>fuel_missing_lbls) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-26" data-line-number="26"><span class="st">      </span><span class="kw">lbl_relabel</span>(</a>
<a class="sourceLine" id="cb13-27" data-line-number="27">        <span class="kw">lbl</span>(<span class="dv">0</span>, <span class="st">&quot;Non-solid Fuel&quot;</span>) <span class="op">~</span><span class="st"> </span><span class="op">!</span>.val <span class="op">%in%</span><span class="st"> </span>fuel_solid_vals,</a>
<a class="sourceLine" id="cb13-28" data-line-number="28">        <span class="kw">lbl</span>(<span class="dv">1</span>, <span class="st">&quot;Solid Fuel&quot;</span>) <span class="op">~</span><span class="st"> </span>.val <span class="op">%in%</span><span class="st"> </span>fuel_solid_vals</a>
<a class="sourceLine" id="cb13-29" data-line-number="29">      ) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb13-30" data-line-number="30"><span class="st">      </span><span class="kw">as_factor</span>(),</a>
<a class="sourceLine" id="cb13-31" data-line-number="31">    <span class="dt">FUELCOOK =</span> <span class="kw">as_factor</span>(FUELCOOK)</a>
<a class="sourceLine" id="cb13-32" data-line-number="32">  )</a></code></pre></div>
<p>Now that we are combining geographies we need to combine the geographic ID variables in the data (GEOLEV1 for Colombia, GEO1_EC2010 for Ecuador and GEO_PE2007 for Peru) into a single variable.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">ipumsi_data &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">GEOLEV1 =</span> <span class="kw">case_when</span>(</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">    COUNTRY <span class="op">==</span><span class="st"> &quot;Colombia&quot;</span> <span class="op">~</span><span class="st"> </span><span class="kw">as.integer</span>(GEOLEV1),</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">    COUNTRY <span class="op">==</span><span class="st"> &quot;Ecuador&quot;</span> <span class="op">~</span><span class="st"> </span>GEO1_EC2010,</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">    COUNTRY <span class="op">==</span><span class="st"> &quot;Peru&quot;</span> <span class="op">~</span><span class="st"> </span>GEO1_PE2007</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  ))</a></code></pre></div>
<p>Then we can summarize to the geographic units and year as before:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">ipumsi_summary &lt;-<span class="st"> </span>ipumsi_data <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="st">  </span><span class="kw">group_by</span>(YEAR, COUNTRY, GEOLEV1) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb15-3" data-line-number="3"><span class="st">  </span><span class="kw">summarize</span>(<span class="dt">pct_solid =</span> <span class="kw">mean</span>(SOLIDFUEL <span class="op">==</span><span class="st"> &quot;Solid Fuel&quot;</span>, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>Another new step when combining multiple geographies is to bind the shape files together. The command <code>rbind()</code> has been implemented for sf (and sp) spatial objects, but before we do that, we want to give each country’s shape data the same structure. When combining non-harmonized geographies or across different geographic levels, the variable names will not be the same. There is some guidance on the IPUMS website about how the variables are named, but some of it will require looking at your shape files.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="co"># Currently each shape file has different variable names</span></a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">names</span>(colombia_shape)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"><span class="kw">names</span>(ecuador_shape)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="kw">names</span>(peru_shape)</a>
<a class="sourceLine" id="cb16-5" data-line-number="5"></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="co"># Keep CNTRY_NAME (because the year-specific geography codes are not unique across</span></a>
<a class="sourceLine" id="cb16-7" data-line-number="7"><span class="co"># countries, so we need to merge using it), ADMIN_NAME (to get the name of </span></a>
<a class="sourceLine" id="cb16-8" data-line-number="8"><span class="co"># geography), rename GEOLEVEL1, IPUM2010 and IPUM2007 to the same variable</span></a>
<a class="sourceLine" id="cb16-9" data-line-number="9"><span class="co"># name, and keep geography, which contains the shape)</span></a>
<a class="sourceLine" id="cb16-10" data-line-number="10">colombia_shape &lt;-<span class="st"> </span>colombia_shape <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-11" data-line-number="11"><span class="st">  </span><span class="kw">select</span>(CNTRY_NAME, ADMIN_NAME, <span class="dt">GEOJOIN =</span> GEOLEVEL1)</a>
<a class="sourceLine" id="cb16-12" data-line-number="12">ecuador_shape &lt;-<span class="st"> </span>ecuador_shape <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-13" data-line-number="13"><span class="st">  </span><span class="kw">select</span>(CNTRY_NAME, ADMIN_NAME, <span class="dt">GEOJOIN =</span> IPUM2010)</a>
<a class="sourceLine" id="cb16-14" data-line-number="14">peru_shape &lt;-<span class="st"> </span>peru_shape <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb16-15" data-line-number="15"><span class="st">  </span><span class="kw">select</span>(CNTRY_NAME, ADMIN_NAME, <span class="dt">GEOJOIN =</span> IPUM2007)</a>
<a class="sourceLine" id="cb16-16" data-line-number="16"></a>
<a class="sourceLine" id="cb16-17" data-line-number="17"><span class="co"># Now we can rbind them together</span></a>
<a class="sourceLine" id="cb16-18" data-line-number="18">all_shapes &lt;-<span class="st"> </span><span class="kw">rbind</span>(colombia_shape, ecuador_shape, peru_shape)</a></code></pre></div>
<p>Then we can join the data in a similar process as before. Since we named the geography ID variables in the shape file GEOJOIN, we use that in the <code>by</code> parameter. Also, because the non-harmonized geography IDs are not unique across countries, we use the country’s name to join as well.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">ipumsi &lt;-<span class="st"> </span><span class="kw">ipums_shape_inner_join</span>(</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  ipumsi_summary, </a>
<a class="sourceLine" id="cb17-3" data-line-number="3">  colombia_shape,</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">  <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;COUNTRY&quot;</span> =<span class="st"> &quot;CNTRY_NAME&quot;</span>, <span class="st">&quot;GEOLEV1&quot;</span> =<span class="st"> &quot;GEOJOIN&quot;</span>)</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">)</a></code></pre></div>
<p>Now we can make the map with all 3 countries:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="co"># Convert the year to a round variable to display in facets</span></a>
<a class="sourceLine" id="cb18-2" data-line-number="2">ipumsi &lt;-<span class="st"> </span>ipumsi <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">census_round =</span> <span class="kw">cut</span>(YEAR, <span class="kw">c</span>(<span class="dv">1984</span>, <span class="dv">1992</span>, <span class="dv">2004</span>, <span class="dv">2014</span>), <span class="kw">c</span>(<span class="st">&quot;1985&quot;</span>, <span class="st">&quot;1993&quot;</span>, <span class="st">&quot;2005-2010&quot;</span>)))</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="co"># Note the function `geom_sf()` is currently only in the development version, </span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co"># so you may need to update ggplot2 to run using </span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="co">#   devtools::install_github(&quot;tidyverse/ggplot2&quot;)</span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="cf">if</span> (<span class="st">&quot;geom_sf&quot;</span> <span class="op">%in%</span><span class="st"> </span><span class="kw">getNamespaceExports</span>(<span class="st">&quot;ggplot2&quot;</span>)) {</a>
<a class="sourceLine" id="cb18-9" data-line-number="9">  <span class="kw">ggplot</span>(<span class="dt">data =</span> ipumsi, <span class="kw">aes</span>(<span class="dt">fill =</span> pct_solid)) <span class="op">+</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="st">    </span><span class="kw">geom_sf</span>() <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="st">    </span><span class="kw">facet_wrap</span>(<span class="op">~</span>census_round) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="st">    </span><span class="kw">scale_fill_continuous</span>(<span class="st">&quot;&quot;</span>, <span class="dt">labels =</span> scales<span class="op">::</span>percent) <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="st">    </span><span class="kw">labs</span>(</a>
<a class="sourceLine" id="cb18-14" data-line-number="14">      <span class="dt">title =</span> <span class="st">&quot;Percent of Children 0-5 Who Live in a Home That Cooks Using Solid Fuel&quot;</span>,</a>
<a class="sourceLine" id="cb18-15" data-line-number="15">      <span class="dt">subtitle =</span> <span class="st">&quot;Colombia (1985, 1993, 2005) Census Data&quot;</span>,</a>
<a class="sourceLine" id="cb18-16" data-line-number="16">      <span class="dt">caption =</span> <span class="kw">paste0</span>(<span class="st">&quot;Source: &quot;</span>, <span class="kw">ipums_file_info</span>(ipumsi_ddi, <span class="st">&quot;ipums_project&quot;</span>))</a>
<a class="sourceLine" id="cb18-17" data-line-number="17">    )</a>
<a class="sourceLine" id="cb18-18" data-line-number="18">}</a></code></pre></div>
</section>
<section id="resources" class="level2">
<h2>Resources for Geographic Analysis in R</h2>
<p>There are so many great resources on working with geographic data in R, it’s hard to pick just a few. Here are a few places to start:</p>
<ul>
<li>The <a href="https://cran.r-project.org/view=Spatial">CRAN Task View for Spatial Analysis</a> describes many of the packages available for spatial analysis in R.</li>
<li>For general information about the sf and sp packages, I recommend reading the vignettes for those packages(<code>vignette(package = &quot;sf&quot;)</code> and <code>vignette(packge = &quot;sp&quot;)</code>).</li>
<li>The <a href="https://rstudio.github.io/leaflet/">leaflet</a> package is great for interactive web-technology based maps.</li>
<li>The CRAN website has a great tutorial called <a href="https://cran.r-project.org/doc/contrib/intro-spatial-rl.pdf">“Introduction to visualizing spatial Data in R”</a> that focuses on visualizing data from the sp package.</li>
<li>The <a href="https://github.com/r-spatial/sf/blob/master/PROPOSAL.md">R consortium proposal for the sf package</a> provides of the history behind the sf package.</li>
</ul>
</section>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
